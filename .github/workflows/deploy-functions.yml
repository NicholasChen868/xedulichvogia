name: Deploy Supabase Edge Functions

on:
  push:
    branches: [main]
    paths:
      - 'supabase/functions/**'
      - 'supabase/config.toml'

  workflow_dispatch:
    inputs:
      function_name:
        description: 'Deploy specific function (leave empty for all)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Edge Functions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase Project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy Functions
        run: |
          # Functions that legitimately need to accept unauthenticated requests
          # (e.g. payment provider webhooks which cannot send JWTs)
          NO_JWT_FUNCTIONS="payment-callback"

          if [ -n "${{ github.event.inputs.function_name }}" ]; then
            echo "Deploying single function: ${{ github.event.inputs.function_name }}"
            DEPLOY_FLAGS=""
            if echo "$NO_JWT_FUNCTIONS" | grep -qw "${{ github.event.inputs.function_name }}"; then
              DEPLOY_FLAGS="--no-verify-jwt"
              echo "⚠️ Deploying WITHOUT JWT verification (webhook endpoint)"
            fi
            supabase functions deploy ${{ github.event.inputs.function_name }} $DEPLOY_FLAGS
          else
            echo "Deploying all functions..."
            FUNCTIONS=$(ls -d supabase/functions/*/ 2>/dev/null | xargs -I{} basename {})
            FAILED=0
            for fn in $FUNCTIONS; do
              echo "--- Deploying: $fn ---"
              DEPLOY_FLAGS=""
              if echo "$NO_JWT_FUNCTIONS" | grep -qw "$fn"; then
                DEPLOY_FLAGS="--no-verify-jwt"
                echo "⚠️ $fn: deploying WITHOUT JWT (webhook endpoint)"
              fi
              if supabase functions deploy "$fn" $DEPLOY_FLAGS; then
                echo "✅ $fn deployed"
              else
                echo "❌ $fn failed"
                FAILED=$((FAILED + 1))
              fi
            done

            if [ $FAILED -gt 0 ]; then
              echo "⚠️ $FAILED function(s) failed to deploy"
              exit 1
            fi
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Health Check
        run: |
          echo "Running health check..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1/health-check" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" 2>/dev/null)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -1)

          echo "Health check response: $HTTP_CODE"
          echo "$BODY" | python3 -m json.tool 2>/dev/null || echo "$BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Health check passed"
          else
            echo "⚠️ Health check returned $HTTP_CODE (function may not be deployed yet)"
          fi

      - name: Post Deploy Summary
        run: |
          echo "### ✅ Edge Functions Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ secrets.SUPABASE_PROJECT_REF }}" >> $GITHUB_STEP_SUMMARY
          echo "**Functions:**" >> $GITHUB_STEP_SUMMARY
          for fn in $(ls -d supabase/functions/*/ 2>/dev/null | xargs -I{} basename {}); do
            echo "- \`$fn\`" >> $GITHUB_STEP_SUMMARY
          done
